<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>LikePebble의 TTS</title>
  <style>body{font-family:system-ui, -apple-system;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#0b1220;color:#e6eef8} .card{background:#0f1724;padding:24px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,.6);text-align:center;width:560px} button{background:#7c5cff;color:white;border:none;padding:10px 16px;border-radius:8px;font-size:16px;cursor:pointer} audio{width:100%;margin-top:12px} textarea{width:100%;height:80px;border-radius:8px;padding:8px;border:1px solid #223344;background:#07101a;color:#e6eef8} select{background:#07101a;color:#e6eef8;border-radius:8px;padding:8px;border:1px solid #223344;margin-left:8px} #log{background:#07101a;border:1px solid #223344;padding:8px;border-radius:8px;color:#9fb0c8;margin-top:12px;height:120px;overflow:auto;font-size:12px;text-align:left} .voices{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:8px}</style>
</head>
<body>
  <div class="card">
    <h2>LikePebble의 TTS</h2>
    <p id="status">텍스트를 입력하면 브라우저 TTS로 재생(한글 지원). 최대 10초 길이 제한.</p>
    <textarea id="text" placeholder="여기에 한국어로 입력하세요 (최대 ~200자, 약 10초)"></textarea>
    <div style="margin-top:8px;display:flex;align-items:center;gap:8px;justify-content:center">
      <label style="font-size:14px">성우</label>
    </div>
    <div id="voices" class="voices">로딩 중...</div>
    <div style="margin-top:8px;display:flex;align-items:center;gap:8px;justify-content:center">
      <label style="font-size:14px">톤</label>
      <select id="tone">
        <option value="default">기본</option>
        <option value="cute">애교</option>
        <option value="calm">차분</option>
        <option value="deep">낮은</option>
        <option value="bright">높은</option>
      </select>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;justify-content:center">
      <button id="speak">재생</button>
      <button id="download">MP3로 저장(서버 필요)</button>
    </div>
    <p id="hint" style="font-size:12px;margin-top:8px;color:#9fb0c8">문자수: <span id="chars">0</span> / 200</p>
    <div id="log"></div>
  </div>
  <script>
    const textarea = document.getElementById('text');
    const speakBtn = document.getElementById('speak');
    const downloadBtn = document.getElementById('download');
    const chars = document.getElementById('chars');
    const status = document.getElementById('status');
    const tone = document.getElementById('tone');
    const voicesDiv = document.getElementById('voices');
    const logEl = document.getElementById('log');
    const MAX_CHARS = 200;

    function log(...args){
      const line = '['+new Date().toLocaleTimeString()+'] '+args.join(' ')+"\n";
      logEl.textContent = line + logEl.textContent;
    }

    textarea.addEventListener('input', ()=>{ chars.textContent = textarea.value.length; if(textarea.value.length>MAX_CHARS) textarea.value = textarea.value.slice(0,MAX_CHARS); });

    function buildVoiceRadios(){
      const voices = speechSynthesis.getVoices() || [];
      voicesDiv.innerHTML = '';
      const koVoices = voices.filter(v=>v.lang && v.lang.startsWith('ko'));
      const list = koVoices.length?koVoices:voices.filter(v=>v.lang && v.lang.startsWith('ko') || true);
      if(list.length===0){ voicesDiv.textContent='브라우저에서 사용할 수 있는 음성이 없습니다.'; log('Voices empty'); return; }
      list.forEach((v,i)=>{
        const id = 'voice_'+i;
        const label = document.createElement('label');
        label.style.display='inline-flex';
        label.style.alignItems='center';
        label.style.gap='6px';
        label.style.background='#07101a';
        label.style.padding='6px 8px';
        label.style.borderRadius='6px';
        label.style.border='1px solid #223344';
        const radio = document.createElement('input');
        radio.type='radio'; radio.name='voice'; radio.value=i; if(i===0) radio.checked=true;
        const span = document.createElement('span'); span.textContent = v.name + ' ('+v.lang+')';
        label.appendChild(radio); label.appendChild(span);
        voicesDiv.appendChild(label);
      });
      log('Voices loaded: '+list.length);
    }

    if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = buildVoiceRadios;
    setTimeout(buildVoiceRadios, 200);

    function getSelectedVoice(){
      const sel = document.querySelector('input[name=voice]:checked');
      if(!sel) return null;
      const idx = parseInt(sel.value);
      const voices = speechSynthesis.getVoices() || [];
      return voices[idx] || null;
    }

    function applyToneSettings(utter, toneName){ utter.rate=1.0; utter.pitch=1.0; switch(toneName){ case 'cute': utter.rate=1.1; utter.pitch=1.3; break; case 'calm': utter.rate=0.9; utter.pitch=0.9; break; case 'deep': utter.rate=0.85; utter.pitch=0.7; break; case 'bright': utter.rate=1.2; utter.pitch=1.2; break; default: break; } }

    async function tryServerTTS(text){
      try{
        const res = await fetch('http://127.0.0.1:8000/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
        if(!res.ok){ log('Server TTS error', res.status); return null; }
        const blob = await res.blob();
        log('Server TTS: received', blob.size+'bytes');
        return URL.createObjectURL(blob);
      }catch(e){ log('Server TTS failed', e.message); return null; }
    }

    function speakTextBrowser(text){
      if(!('speechSynthesis' in window)){ alert('Web Speech API 미지원'); return; }
      const utter = new SpeechSynthesisUtterance(text); utter.lang='ko-KR';
      const voice = getSelectedVoice();
      if(voice) utter.voice = voice;
      applyToneSettings(utter, tone.value);
      utter.onstart = ()=>{ status.textContent='재생 중...'; log('Browser TTS started', utter.voice?utter.voice.name:'(no voice)'); };
      utter.onend = ()=>{ status.textContent='재생 완료'; log('Browser TTS ended'); };
      speechSynthesis.cancel(); speechSynthesis.speak(utter);
    }

    speakBtn.addEventListener('click', async ()=>{
      const t = textarea.value.trim(); if(!t){ status.textContent='내용을 입력하세요.'; return; }
      const estSec = Math.ceil(t.length/20); if(estSec>10){ status.textContent='길이 초과 위험'; log('Length estimate',estSec+'s'); return; }
      status.textContent='처리 중...'; log('Play request, len='+t.length);
      const serverUrl = await tryServerTTS(t);
      if(serverUrl){ status.textContent='서버 음성 재생'; const a = new Audio(serverUrl); a.onended=()=>log('Server audio ended'); a.play(); return; }
      status.textContent='서버 미응답: 브라우저 TTS로 폴백'; log('Fallback to browser TTS'); speakTextBrowser(t);
    });

    downloadBtn.addEventListener('click', ()=>{ alert('MP3 저장은 서버 TTS 필요'); });

    window._tts_debug = {buildVoiceRadios, log};
  </script>
</body>
</html>